# üîê Login Persistence Fix - Critical Update

## The Problem

Your users were experiencing "login details aren't being saved" because:

1. **JWT Secret Mismatch**: The code was looking for `JWT_SECRET` but Replit provides `SESSION_SECRET`
2. **Token Invalidation**: Without a consistent secret, login tokens would become invalid
3. **Session Loss**: Users had to re-login constantly

## The Fix

### ‚úÖ Code Changes (v11.5)

**Updated:** `server/routes.ts` (Line 15)
```typescript
// BEFORE:
const JWT_SECRET = process.env.JWT_SECRET || "your-secret-key-change-in-production";

// AFTER:
const JWT_SECRET = process.env.SESSION_SECRET || process.env.JWT_SECRET || "your-secret-key-change-in-production";
```

Now the app checks for `SESSION_SECRET` first (which exists in your environment), then falls back to `JWT_SECRET`, then default.

### ‚úÖ Environment Configuration

The deploy script automatically generates a random `SESSION_SECRET` in your `.env` file:

```bash
# .env file (auto-generated by deploy.sh)
SESSION_SECRET=<random-32-byte-hex-string>
```

**CRITICAL:** Once set, **never change this value** or all users will be logged out!

## How Login Works Now

1. **User logs in** ‚Üí Server verifies credentials
2. **JWT created** ‚Üí Signed with `SESSION_SECRET`
3. **Token sent to browser** ‚Üí Stored in `localStorage`
4. **Future requests** ‚Üí Token validated with same `SESSION_SECRET`
5. **Token expires after 7 days** ‚Üí User auto-logged out

## Deployment Instructions

### Fresh Deployment

```bash
# 1. Upload and extract package
scp ibiki-sms-v11.5-full.tar.gz root@151.243.109.79:/root/
ssh root@151.243.109.79
cd /root
tar -xzf ibiki-sms-v11.5-full.tar.gz
cd ibiki-sms

# 2. Deploy (creates .env with SESSION_SECRET)
sudo ./deploy.sh

# 3. Verify SESSION_SECRET was created
cat .env | grep SESSION_SECRET
# Should show: SESSION_SECRET=<random-hex-string>
```

### Update Existing Deployment

```bash
# 1. SSH to your server
ssh root@151.243.109.79
cd /root/ibiki-sms  # or wherever you deployed

# 2. Backup current .env (CRITICAL!)
cp .env .env.backup

# 3. Upload new files
# (Upload ibiki-sms-v11.5-full.tar.gz to /root/)

# 4. Extract update
tar -xzf ../ibiki-sms-v11.5-full.tar.gz --strip-components=1

# 5. Restore your .env (preserves SESSION_SECRET!)
cp .env.backup .env

# 6. Reinstall and restart
npm ci
npm run db:push --force
pm2 restart ibiki-sms
pm2 logs ibiki-sms --lines 50
```

## Verification Steps

### 1. Check Environment Variable

```bash
# On your server
cat .env | grep SESSION_SECRET
```

Should output something like:
```
SESSION_SECRET=a1b2c3d4e5f6...  # 64-character hex string
```

### 2. Test Login Persistence

1. Open browser ‚Üí Navigate to http://151.243.109.79
2. Log in with your credentials
3. **Close the browser completely**
4. Reopen browser ‚Üí Navigate to http://151.243.109.79
5. ‚úÖ You should **still be logged in** (no login page)

### 3. Check PM2 Logs

```bash
pm2 logs ibiki-sms --lines 50
```

Should NOT see errors like:
- ‚ùå "Invalid or expired token"
- ‚ùå "Authentication required"
- ‚ùå "JWT verification failed"

## Troubleshooting

### Problem: Still getting logged out

**Solution 1: Verify SESSION_SECRET exists**
```bash
cat .env | grep SESSION_SECRET
```

If missing, add it manually:
```bash
# Generate a random secret
SESSION_SECRET=$(openssl rand -hex 32)
echo "SESSION_SECRET=$SESSION_SECRET" >> .env

# Restart app
pm2 restart ibiki-sms
```

**Solution 2: Clear browser localStorage**
```javascript
// In browser console (F12)
localStorage.clear();
location.reload();
```

Then try logging in again.

### Problem: Users logged out after update

**Cause:** SESSION_SECRET was changed or lost during update

**Solution:**
```bash
# Restore from backup
cp .env.backup .env
pm2 restart ibiki-sms
```

**Prevention:** Always backup `.env` before updates!

### Problem: Database connection errors

**Cause:** DATABASE_URL missing or invalid

**Solution:**
```bash
# Check if DATABASE_URL is set
cat .env | grep DATABASE_URL

# If missing, add your Neon/Supabase connection string
echo "DATABASE_URL=postgresql://user:pass@host/db?sslmode=require" >> .env
pm2 restart ibiki-sms
```

## Security Notes

1. **SESSION_SECRET is critical**: Treat it like a password
2. **Never commit to git**: Already in `.gitignore`
3. **Never share publicly**: Keep `.env` file private
4. **Backup .env file**: Store securely before updates
5. **7-day expiration**: Tokens automatically expire for security

## What's New in v11.5

‚úÖ Fixed JWT secret environment variable mismatch  
‚úÖ Login sessions now persist correctly  
‚úÖ Database persistence for all user data  
‚úÖ Complete payload translation (EN ‚Üî ‰∏≠Êñá)  
‚úÖ Updated deployment guide  
‚úÖ .env.example with detailed comments  

## Need Help?

If users still experience login issues after this fix:

1. **Check PM2 logs**: `pm2 logs ibiki-sms`
2. **Verify .env**: Ensure SESSION_SECRET exists and hasn't changed
3. **Test manually**: Login ‚Üí Close browser ‚Üí Reopen
4. **Clear browser data**: localStorage might be corrupted
5. **Check database**: Ensure PostgreSQL connection is working

---

**Version:** 11.5  
**Date:** November 19, 2025  
**Critical Fix:** Login persistence resolved
