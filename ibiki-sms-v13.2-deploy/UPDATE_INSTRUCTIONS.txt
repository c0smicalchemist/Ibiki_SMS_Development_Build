================================================================================
  ðŸ”„ SAFE UPDATE INSTRUCTIONS
  Update Application WITHOUT Losing Client Data
================================================================================

âš ï¸  **CRITICAL: You have existing clients - DO NOT use full-deploy.sh!**

The full-deploy.sh script will recreate the database and wipe all user data.
Instead, use the UPDATE script to safely update your application.

================================================================================
  âœ… SAFE UPDATE PROCESS
================================================================================

WHAT THIS UPDATE DOES:
  âœ… Updates application code (new features, bug fixes)
  âœ… Updates dependencies (npm packages)
  âœ… Updates database schema (adds new tables/columns)
  âœ… PRESERVES all existing data:
     - User accounts
     - Client profiles
     - API keys
     - Message logs
     - Credit transactions
     - All settings

WHAT THIS UPDATE DOES NOT DO:
  âŒ Does NOT drop database
  âŒ Does NOT delete users
  âŒ Does NOT wipe data
  âŒ Does NOT require clients to re-signup

================================================================================
  ðŸ“¦ STEP 1: DOWNLOAD UPDATE PACKAGE
================================================================================

Download the v13.0 FIXED package (8 parts):
  - ibiki-sms-v13.0-FIXED-part-01.tar.gz.part
  - ibiki-sms-v13.0-FIXED-part-02.tar.gz.part
  - ibiki-sms-v13.0-FIXED-part-03.tar.gz.part
  - ibiki-sms-v13.0-FIXED-part-04.tar.gz.part
  - ibiki-sms-v13.0-FIXED-part-05.tar.gz.part
  - ibiki-sms-v13.0-FIXED-part-06.tar.gz.part
  - ibiki-sms-v13.0-FIXED-part-07.tar.gz.part
  - ibiki-sms-v13.0-FIXED-part-08.tar.gz.part

================================================================================
  ðŸ“¤ STEP 2: UPLOAD TO SERVER
================================================================================

Upload all 8 parts to a TEMPORARY directory:

```bash
# Create temporary directory
ssh root@151.243.109.79
mkdir /root/ibiki-update
exit

# Upload parts
scp ibiki-sms-v13.0-FIXED-part-*.tar.gz.part root@151.243.109.79:/root/ibiki-update/
```

âš ï¸  DO NOT extract to /root/ibiki-sms yet - we'll do that safely!

================================================================================
  ðŸ”§ STEP 3: BACKUP CURRENT .ENV (VERY IMPORTANT!)
================================================================================

SSH to server and backup your .env file:

```bash
ssh root@151.243.109.79
cd /root/ibiki-sms

# Backup .env (contains database credentials)
cp .env /root/.env.backup

# Verify backup exists
ls -la /root/.env.backup

# âœ… You should see the .env.backup file
```

This backup ensures your database connection is not lost!

================================================================================
  ðŸ“¦ STEP 4: EXTRACT UPDATE PACKAGE
================================================================================

```bash
cd /root/ibiki-update

# Verify all 8 parts are present
ls -l ibiki-sms-v13.0-FIXED-part-*.tar.gz.part

# Reassemble package
cat ibiki-sms-v13.0-FIXED-part-*.tar.gz.part > ibiki-sms-v13.0-FULL.tar.gz

# Verify size (~74 MB)
ls -lh ibiki-sms-v13.0-FULL.tar.gz

# Extract to temporary location
tar -xzf ibiki-sms-v13.0-FULL.tar.gz
```

================================================================================
  ðŸ”„ STEP 5: SAFE UPDATE (PRESERVES DATA!)
================================================================================

Now copy new code over old code (keeping your .env):

```bash
# Stop application temporarily
PM2_HOME=/home/ibiki/.pm2 pm2 stop ibiki-sms

# Backup current application (just in case)
cp -r /root/ibiki-sms /root/ibiki-sms.backup

# Copy NEW code over OLD code
cp -r /root/ibiki-update/ibiki-sms/* /root/ibiki-sms/

# Restore your .env file (CRITICAL!)
cp /root/.env.backup /root/ibiki-sms/.env

# Verify .env is restored
cat /root/ibiki-sms/.env | grep DATABASE_URL
# âœ… Should show your database connection string
```

================================================================================
  âš¡ STEP 6: RUN UPDATE SCRIPT
================================================================================

The update script safely updates everything:

```bash
cd /root/ibiki-sms

# Make update script executable
chmod +x update.sh

# Run update script
./update.sh
```

The script will:
1. âœ… Backup .env (again, for safety)
2. âœ… Install/update dependencies (npm install)
3. âœ… Build application (npm run build)
4. âœ… Update database schema safely (npm run db:push)
   - Adds new tables/columns
   - Does NOT delete data
5. âœ… Restart application (PM2)
6. âœ… Verify everything works

================================================================================
  âœ… STEP 7: VERIFY UPDATE
================================================================================

Check that everything works:

```bash
# 1. Check application is running
PM2_HOME=/home/ibiki/.pm2 pm2 status
# âœ… Should show: ibiki-sms "online"

# 2. Check logs for errors
PM2_HOME=/home/ibiki/.pm2 pm2 logs ibiki-sms --lines 20
# âœ… Should see: "serving on port 5000"
# âŒ Should NOT see errors

# 3. Check database connection
PM2_HOME=/home/ibiki/.pm2 pm2 logs ibiki-sms --lines 50 | grep -i "database\|postgres"
# âœ… Should show database is connected

# 4. Test in browser
# Open: http://151.243.109.79
# âœ… Should see landing page

# 5. Test client login
# Have an existing client try to login
# âœ… Should work with existing credentials
# âœ… Should see their existing data
```

================================================================================
  ðŸ‘¥ STEP 8: VERIFY CLIENT DATA
================================================================================

Make sure all client data is still there:

```bash
# Connect to database
sudo -u postgres psql ibiki_sms

# Check users are still there
SELECT id, email, name, role FROM users;
# âœ… Should see all your existing users

# Check API keys are still there
SELECT id, "userId", "keyPrefix", "keySuffix" FROM api_keys;
# âœ… Should see all existing API keys

# Check client profiles
SELECT "userId", credits FROM client_profiles;
# âœ… Should see all client credit balances

# Exit database
\q
```

All data should be intact!

================================================================================
  ðŸ§¹ STEP 9: CLEANUP (OPTIONAL)
================================================================================

After verifying everything works, clean up temporary files:

```bash
# Remove update directory
rm -rf /root/ibiki-update

# Remove old backup (keep recent .env.backup though!)
rm -rf /root/ibiki-sms.backup

# Keep .env.backup in case you need it!
# DO NOT delete: /root/.env.backup
```

================================================================================
  ðŸš¨ WHAT IF SOMETHING GOES WRONG?
================================================================================

IF UPDATE FAILS, ROLLBACK:

```bash
# Stop new version
PM2_HOME=/home/ibiki/.pm2 pm2 stop ibiki-sms

# Restore old version
rm -rf /root/ibiki-sms
mv /root/ibiki-sms.backup /root/ibiki-sms

# Restart old version
cd /root/ibiki-sms
PM2_HOME=/home/ibiki/.pm2 pm2 restart ibiki-sms

# Check logs
PM2_HOME=/home/ibiki/.pm2 pm2 logs ibiki-sms
```

Everything should work as before!

================================================================================
  ðŸ“‹ WHAT'S NEW IN v13.0 FIXED
================================================================================

NEW FEATURES:
  âœ… NEW API endpoint: GET /api/v2/sms/messages
     - Check status of ALL messages sent
     - No need to track individual message IDs
  
  âœ… Bug fixes:
     - Fixed schema import errors
     - Fixed Pool import from @neondatabase/serverless
     - All compilation errors resolved

  âœ… Updated documentation
     - API docs updated with new endpoint
     - Complete usage examples

EXISTING FEATURES (ALL PRESERVED):
  âœ… User authentication
  âœ… Client management
  âœ… API key system
  âœ… Credit tracking
  âœ… Message logging
  âœ… 2-way SMS (incoming messages)
  âœ… ExtremeSMS integration
  âœ… Admin dashboard
  âœ… Client dashboard

================================================================================
  âš ï¸  IMPORTANT REMINDERS
================================================================================

1. âŒ NEVER run full-deploy.sh on a server with existing data
   - It will recreate the database
   - All users will be lost
   
2. âœ… ALWAYS use update.sh for updates
   - Preserves all data
   - Safe database migrations
   
3. âœ… ALWAYS backup .env before updating
   - Contains database credentials
   - Critical for preserving connection
   
4. âœ… Test updates on development first (if possible)
   - Ensure everything works
   - Then deploy to production

5. âœ… Keep backups
   - Backup .env regularly
   - Backup database regularly:
     sudo -u postgres pg_dump ibiki_sms > /root/backup-$(date +%Y%m%d).sql

================================================================================
  ðŸ“Š UPDATE SUMMARY
================================================================================

SAFE UPDATE PROCESS:
  1. Download v13.0 FIXED package
  2. Upload to /root/ibiki-update
  3. Backup .env file
  4. Extract package
  5. Stop application
  6. Copy new code over old
  7. Restore .env
  8. Run ./update.sh
  9. Verify everything works
  10. Clients can still login!

TIME REQUIRED: 10-15 minutes

DATA SAFETY:
  âœ… Zero data loss
  âœ… All users preserved
  âœ… All settings preserved
  âœ… No client re-signup needed

BENEFITS:
  âœ… New features
  âœ… Bug fixes
  âœ… Better performance
  âœ… Enhanced API

================================================================================
  ðŸŽ‰ YOUR CLIENTS ARE SAFE!
================================================================================

Following this process ensures:
  âœ… No user data loss
  âœ… No downtime (minimal - just restart)
  âœ… All existing clients continue working
  âœ… New features available immediately

Your clients won't even notice the update - they can continue using their
existing accounts without any interruption! ðŸš€

================================================================================
